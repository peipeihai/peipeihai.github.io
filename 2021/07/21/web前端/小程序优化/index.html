<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
<meta name="google-site-verification" content="PMsD39EGVksOtM5ZQp2bioN81CozCXsClQnjVFVnxyk" />
<meta name="baidu-site-verification" content="code-z6M1yoz4m9" />
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-center-circle.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"peipeihai.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="导语 | 如果你的小程序也遇到了性能问题，我们的实践经验也许可以给到你启发，我们从小程序的启动、加载到交互都进行了探索。顺便说一句，这篇文章在腾讯内部曾被小程序技术总监打赏。  缘起事情，要从一个周末惬意的下午开始说起……  那天，手机突然被唤醒，弹出多条微信消息。原来是这周末正在校园推广的活动群发来的，想起之前大家有条不紊的开发进度，和产品沟通的友好过程，应该是活动反响不错。 现实是残酷的： “">
<meta property="og:type" content="article">
<meta property="og:title" content="小程序优化">
<meta property="og:url" content="https://peipeihai.github.io/2021/07/21/web%E5%89%8D%E7%AB%AF/%E5%B0%8F%E7%A8%8B%E5%BA%8F%E4%BC%98%E5%8C%96/index.html">
<meta property="og:site_name" content="皮皮蟹">
<meta property="og:description" content="导语 | 如果你的小程序也遇到了性能问题，我们的实践经验也许可以给到你启发，我们从小程序的启动、加载到交互都进行了探索。顺便说一句，这篇文章在腾讯内部曾被小程序技术总监打赏。  缘起事情，要从一个周末惬意的下午开始说起……  那天，手机突然被唤醒，弹出多条微信消息。原来是这周末正在校园推广的活动群发来的，想起之前大家有条不紊的开发进度，和产品沟通的友好过程，应该是活动反响不错。 现实是残酷的： “">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-07-21T07:48:54.000Z">
<meta property="article:modified_time" content="2021-07-21T07:49:07.384Z">
<meta property="article:author" content="barretyi">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://peipeihai.github.io/2021/07/21/web%E5%89%8D%E7%AB%AF/%E5%B0%8F%E7%A8%8B%E5%BA%8F%E4%BC%98%E5%8C%96/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>小程序优化 | 皮皮蟹</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">皮皮蟹</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">劝君莫惜金缕衣，劝君惜取少年时</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-首页">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-关于">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-标签">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-分类">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-归档">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://peipeihai.github.io/2021/07/21/web%E5%89%8D%E7%AB%AF/%E5%B0%8F%E7%A8%8B%E5%BA%8F%E4%BC%98%E5%8C%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/7858692?v=4">
      <meta itemprop="name" content="barretyi">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="皮皮蟹">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          小程序优化
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-07-21 15:48:54 / 修改时间：15:49:07" itemprop="dateCreated datePublished" datetime="2021-07-21T15:48:54+08:00">2021-07-21</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>导语 | 如果你的小程序也遇到了性能问题，我们的实践经验也许可以给到你启发，我们从小程序的启动、加载到交互都进行了探索。顺便说一句，这篇文章在腾讯内部曾被小程序技术总监打赏。</p>
<ol>
<li>缘起<br>事情，要从一个周末惬意的下午开始说起……</li>
</ol>
<p>那天，手机突然被唤醒，弹出多条微信消息。原来是这周末正在校园推广的活动群发来的，想起之前大家有条不紊的开发进度，和产品沟通的友好过程，应该是活动反响不错。</p>
<p>现实是残酷的：</p>
<p>“我们的小程序打开慢成狗！”</p>
<p>“这个 loading 加载的过程也太久了！”</p>
<p>“滚动加载有点卡，而且很容易报错……”</p>
<p>看到的是最直接的控诉。</p>
<p>看到用户的录屏，这几个问题确实是有出现，所以我们还是需要对小程序进行一次主流程的性能优化，三句控诉可以总结为 3 个点：</p>
<p>小程序启动慢</p>
<p>小程序请求慢</p>
<p>小程序交互慢</p>
<p>2.定位<br>2.1. 启动慢<br>收到反馈后第一反应是，用户是不是网速太慢了，自己跑一遍，发现自己的手机跑起来都是没问题的，灰常流畅，下意识的可能想录个屏回复过去。</p>
<p>图片</p>
<p>不过有用户录屏在那，当然不能这么草率，所以我们查了下管理后台小程序在不同网络下的大盘数据：</p>
<p>网络 启动耗时<br>总体 3.6s<br>WIFI 3.5s<br>4G 3.9s<br>2G/3G 4.1s</p>
<p>从统计看，总体 3.7s 的启动耗时，网络对于启动耗时是会有影响的，但影响没有很大，就算是 2G-3G 下跟大盘的数据对比也没有慢很多，可见事情并不简单。</p>
<p>于是我们从另外一个维度来看一下大盘数据：</p>
<p>机型 启动耗时 JS 注入 初次渲染<br>总体 3.6s 0.29s 0.16s<br>高端机 2.9s 0.19s 0.06s<br>中端机 4.8s 0.42s 0.19s<br>低端机 7.9s 0.72s 0.43s<br>从这里就可以看出问题来了，手机的性能对于小程序的启动速度影响非常大，低端机相对高端机有 2-3 倍的差距，特别是渲染层甚至有 5-6 倍的差距，而且问题反馈的用户所使用的手机也确实是中低端机，但用户使用什么手机我们也没法控制，那这里有办法去优化吗？</p>
<p>针对这个问题，我们需要了解一下小程序的启动过程，根据官方文档的介绍，小程序的启动可以分为下面几个步骤：</p>
<p>图片</p>
<p>上图描述了用户点击小程序开始到页面开始请求数据的一个完整的冷启动过程，而小程序初始化的过程（信息准备、环境准备）占用了比较长的时间，但这部分的工作是由微信客户端来完成，开发者无法干预，所以我们只能聚焦于后续的步骤（下载代码包、注入代码包、初次渲染）。</p>
<p>根据官方文档的介绍，这一部分的可优化手段有：</p>
<p>减小代码包体积</p>
<p>降低代码复杂度</p>
<p>减少同步代码接口调用</p>
<p>降低页面结构复杂度</p>
<p>减少自定义组件数量</p>
<p>后面 4 条在技术上没有特别好的限制手段，需要我们在 Code Review 的时候对复杂度和开销大的接口调用进行把关，复杂度这里还可以借助如 CodeCC（腾讯内部代码检查工具） 这类工具去进行分析，减少自定义组件数量，这个是比较难以抉择的，需要在代码可读性、可复用性之间做个取舍，不是本次优化的重点。</p>
<p>所以我们就重点关注的代码包体积问题，通过我们的 CI 记录可以收集到我们的总包大小：</p>
<p>图片</p>
<p>可以看到主包体积达到 1949.71KB，接近了 2M 的极限了，在通过依赖分析后，发现除了一些是未使用到的模块和组件外，很大一部分内容是静态资源，同时我们也在官方文档中看到这样一句话：</p>
<p>小程序代码包在下载时会使用 ZSTD 算法进行压缩，这些资源文件会占用大量代码包体积，并且通常难以进一步被压缩，对于下载耗时的影响比代码文件大得多。</p>
<p>所以我们要减小代码包的体积，最直接的方法就是将非必要的资源去除掉：</p>
<p>对静态资源进行优化，将非必要的静态资源文件上传到 CDN</p>
<p>对小程序的组件进行依赖分析，过滤掉未使用的组件</p>
<p>同时我们还关注到，有一些分包特别小，但是由于是普通分包，在打开这些页面的时候还需要先下载主包，这里在包下载耗时上其实是有一些浪费的，比较典型的就是 WebView 页面，他们往往只需要对参数进行处理，对于主包的依赖不是很强，所以这里还有一个可以优化的点：</p>
<p>对独立性比较强的页面进行独立分包，尽可能的减少包下载耗时</p>
<p>2.2. 请求慢<br>我们通过日志查到这个用户的首页数据请求返回会到 3-4s，请求慢在正常情况下会有这么两种情况：</p>
<p>并发量突增导致服务器响应慢</p>
<p>用户网速较慢导致发送请求和接收请求变慢</p>
<p>我们通过日志统计发现用户的访问时间端，请求量跟平时保持一致，看大盘请求耗时的统计，也没有产生大的波动：</p>
<p>图片</p>
<p>所以基本可以排除是后台的问题，虽然大盘的数据在 500ms 左右，但是当用户网络不好的情况下，这一块要怎么保证呢？</p>
<p>答案当然是做提前拉取，当用户冷启动的时候，我们可以使用小程序官方提供的数据预拉取能力提前拉取，从小程序的启动耗时看，完全可以 cover 掉我们的接口请求耗时，可以让小程序启动成功后就直接渲染页面。</p>
<p>在热启动的情况下，请求慢主要体现在用户交互时发生的请求和页面切换时发生的请求，交互的情况我们下一节在分析，这里主要看页面切换，从我们的统计数据来看，页面切换的耗时大概在 400ms 左右，而其中能够利用的时间大概是 50ms-100ms：</p>
<p>图片<br>route 时间</p>
<p>利用页面切换的这个时间提前对页面的数据进行加载，可以减少用户感观上的数据请求时间，同时在第一次请求之后可以根据一定的策略对页面的数据进行缓存，从而可以达到二次进入页面秒开的效果。</p>
<p>总结来看，请求慢的优化手段有下面几个，而且理论上效果都会很显著：</p>
<p>冷启动开启数据预拉取</p>
<p>页面路由切换时提前拉取数据</p>
<p>对数据进行缓存</p>
<p>2.3. 交互慢<br>先说一下这里的交互慢具体指什么，我们收到用户反馈的现象是：用户首屏顺利加载出来之后，后续滚动加载和一些按钮点击的响应非常慢并且很容易报错。收到这个反馈后定位了很久，讲道理如果是因为用户网络问题导致的请求很慢，应该所有的请求都会很慢，但是用户表现出来的现象是后续的加载以及交互很慢，反而首屏还算正常。</p>
<p>通过日志查询，我们发现这个用户的请求报错都是请求超时，为什么超时会集中在交互加载这里呢？定位了一段时间后我们发现一个用户的报错都集中在首屏加载之后就立马下滑或者点击，如果过了一段时间再点击又不会报错。</p>
<p>发现这个现象后，我们想到了官方文档关于网络使用说明的一个限制：</p>
<p>wx.request、wx.uploadFile、wx.downloadFile 的最大并发限制是 10 个</p>
<p>再结合我们对于 wx.request 的封装，请求超时的计时器是从调用 wx.request 的时候就开始了，如果请求并发超过了限制，那么就很容易出现请求超时，而当我们从第一个业务接口请求到数据后就会进行一系列的数据上报，包括 pv、组件曝光、关键链路打点等等，所以我们利用 Whistle 的 resDelay 方法，将我们的上报请求都延迟 5000ms 返回，果然就复现了用户反馈的那种情况。</p>
<p>图片</p>
<p>找到问题之后也就明确了需要优化的方向：</p>
<p>保障与用户体验相关的业务请求正常发送</p>
<p>交互慢还有别的原因吗？在继续挖掘性能瓶颈的过程中，发现腾讯课堂小程序的课程详情页内容非常多，有 5-6 屏的高度，而用户只会关心首屏是不是更快的呈现出来，但是我们原本的处理方式是比较粗暴的，拿到详情页的数据之后对数据进行处理，格式化成整个页面所需要的数据之后一次性调用 this.setData 来更新页面，所以如果要提升首屏速度，这里需要做的就是：</p>
<p>页面分步渲染</p>
<p>2.4. 优化点归总<br>再归总一下需要优化的点和方向：</p>
<p>启动慢主要从优化代码包上下手：</p>
<p>对静态资源进行优化，将非必要的静态资源文件上传到 CDN</p>
<p>对小程序的组件进行依赖分析，过滤掉未使用的组件</p>
<p>对独立性比较强的页面进行独立分包，减少主包下载耗时</p>
<p>请求慢主要从预加载和缓存下手：</p>
<p>冷启动开启数据预拉取</p>
<p>页面路由切换时提前拉取数据</p>
<p>对数据进行缓存</p>
<p>交互慢需要从发起请求和页面渲染下手：</p>
<p>保障与用户体验相关的业务请求正常发送</p>
<p>页面分步渲染</p>
<ol start="3">
<li>优化<br>3.1. 启动优化<br>3.1.1. 独立分包<br>由于用户反馈主要是因为校园推广活动来的，而活动页面我们是通过 WebView 内嵌 H5 来承载的，而 WebView 页面的启动过程和小程序原生页面还不太一样：</li>
</ol>
<p>图片</p>
<p>实际上 WebView 页面只需要完善登录态传递的功能，对于主包的依赖不是很大，而且这部分页面更大的性能问题需要在 h5 那边来优化，所以我们第一时间对其进行了独立分包处理。</p>
<p>最终的优化效果还不错，因为启动过程中不需要下载主包，启动性能提升了 30%。</p>
<p>3.1.2. 静态资源上 CDN<br>我们小程序构成主要是由原生页面 + kbone 页面组成的，kbone 是采用的官方的方案，通过 webpack 构建，有很多单独打包静态资源的方案。而我们的原生页面是使用 gulp 进行构建的，原来主要的功能是将源码中的 ts 转成 js，同时对 css 文件通过 postcss 转成 wxss，由于 wxss 不支持引用相对路径，所以在 wxss 中引用的图片和字体都是转成 base64 的，然后对其余的文件如 json、wxml 文件则直接复制到产物中去。</p>
<p>这样的处理方式比较粗暴，通过 postcss 将 background-image 所引用的本地图片都转成 base64，还会导致很多图片在项目中占用了 2 倍的体积。</p>
<p>图片<br>CI 流程-优化前</p>
<p>所以我们首先需要将源码下的静态资源匹配到并单独构建出来，并且为了规避同名文件的问题，需要对资源打个 hashtag，我们这里需要用到一个 gulp 插件 gulp-rev，这个插件可以对基于资源的内容进行 hash。</p>
<p>图片<br>CI 流程-优化后</p>
<p>将图片上到 CDN 后，把 css、js、json、wxml 中的引用路径替换成 CDN 地址，具体的替换逻辑如下。</p>
<p>图片<br>CDN 流程</p>
<p>3.1.3. 过滤未使用组件<br>随着业务的迭代，不可避免的会有一些组件被废弃了但是难以察觉，通过我们团队开发的小程序脚手架 imweb-miniprogram-cli 对页面所使用到的组件进行分析，可以把项目中未使用到的组件给过滤出来，不会打包到最终的产物中，大致的思路如下：</p>
<p>图片<br>组件依赖</p>
<p>从 app.json 开始，拿到小程序所配置的所有页面和分包，通过检查 App、页面、分包中所使用的自定义组件来进行收集，并且递归检查自定义组件所使用的组件，如果检测到有未使用的组件，也会给到提示，非常友好：</p>
<p>图片<br>组件过滤</p>
<p>可以看到在我们的项目中就发现了好几个未使用到的组件。</p>
<p>3.2. 请求优化<br>3.2.1. 数据预拉取<br>数据预拉取需要在小程序的管理后台开启，数据来源可以选择开发者服务器或者云开发，选择开发者服务器的话会有一些限制，如果是直接填写 CGI 地址，就只能拉取一种数据，不够灵活，而如果再搭建一个服务去做预拉取涉及到的工作量又会很大，所以我们选择的是云开发的方式，大致流程如下图:</p>
<p>图片<br>数据预拉取-大概</p>
<p>当小程序启动的时候，微信客户端会根据配置去拉取指定的云函数，在云函数中通过 cl5 调用业务后台的服务拉取到需要的数据，拉取到后客户端会将数据缓存在本地，当小程序启动成功后，在业务代码中调用 wx.getBackgroundFetchData 就可以拿到预拉取的数据，如果缓存数据拉到的是所需要的数据则可以直接渲染，如果不是则降级到业务中再拉一次接口。</p>
<p>在云函数中可以拿到本次小程序启动的 path 和 query 参数，所以我们可以根据这两个参数来判断本次预拉取需要调用业务后台的哪个服务，从而达到从不同的页面启动小程序都可以通过一个云函数预拉取到所需要的数据。</p>
<p>const preFetchMap = {<br>‘pages/index/index’: fetchIndex,<br>‘pages/course/course’: fetchCourse,<br>}</p>
<p>// 云函数入口函数<br>exports.main = async (event) =&gt; {<br>const { path, query = ‘’ } = event;<br>const fetchFn = preFetchMap[path];</p>
<p>if (fetchFn) {<br>const res = await fetchFn(query);<br>return res;<br>}</p>
<p>return {<br>error: {<br>event,<br>retcode: -1002,<br>msg: <code>$&#123;path&#125;页面未设置预拉取逻辑</code><br>}<br>};<br>};</p>
<p>不过要注意的是，因为小程序自身做了很多初始化的优化，有可能在小程序启动后，预拉取的数据还没有返回，所以我们做了进一步的优化，在业务拉取的过程中通过 wx.onBackgroundFetchData 监听预拉取的返回，收到返回就直接渲染 ，尽可能的使用预拉取的数据来渲染首屏。</p>
<p>图片<br>数据预拉取</p>
<p>3.2.2. 提前拉取 &amp; 数据缓存<br>前面已经提到过，提前拉取就是要利用小程序切换页面的空隙开始拉取数据，从而在感官上较少数据请求的时间，整体的逻辑是通过封装的跳转逻辑，对应的页面添加不同的数据拉取逻辑，并将拉取的 promise 挂载在 App 上，当页面切换完成后优先使用 App 上的 promise 来获取数据。</p>
<p>数据缓存则是在数据拉取成功后，将比较固定的数据通过 wx.setStorage 缓存在本地，当第二次切换到这个页面时，先使用本地缓存的数据进行渲染，后面再通过拉取的数据来进行更新。</p>
<p>图片<br>提前拉取</p>
<p>3.3. 交互优化<br>3.3.1. 业务请求保障<br>保障业务请求的核心思路是让业务请求优先，我们封装了一个 排队请求模块 ，通过对 wx.request API 的拦截，将请求根据配置有个优先级排序，低优先级的会在请求并发数达到一定的阈值之后被推到等待队列 WaitingQueue 中，留出足够的通道给到高优先级的业务请求。</p>
<p>图片<br>请求排队</p>
<p>3.3.2. 分步渲染<br>这里的方案相信大家也能很好理解，主要是优先处理首屏需要的数据并通过 setData 更新视图，然后在处理其余的数据。但根据官方文档的说明：</p>
<p>setData 函数用于将数据从逻辑层发送到视图层（异步），同时改变对应的 this.data 的值（同步）。</p>
<p>而小程序代码执行顺序也遵循 JS 的事件循环机制，仅仅是在处理后的数据调用 setData ，然后继续或者通过 Promise 处理下一步的话，并不能达到分步渲染的目的，而直接通过回调的方式在 setTimeout 中使用嵌套渲染，代码的可读性会变差，同时也不是很优雅。我们的解决方式是利用 setTimeout 封装了一个符合 Promise 标准的方法，从而可以像使用 Promise 那样继续分步渲染：</p>
<p>图片</p>
<ol start="4">
<li>成果<br>经过这一系列的优化，效果还是比较明显的：</li>
</ol>
<p>4.1. 包大小<br>在包大小方面：</p>
<p>总包从 9132.94KB 减小到 6736.42KB，减少了 27%；</p>
<p>主包从 1949.71KB 减小到 985.96KB，减少了 49.5%；</p>
<p>从启动耗时的数据看，下载耗时和 JS 注入耗时都有明显的下降：</p>
<p>图片<br>启动耗时</p>
<p>再看打开耗时分布，可以看到 3s 内打开的用户比例有明显增加，从 56.26%增加到 64.25%;</p>
<p>图片<br>打开分布</p>
<p>4.2. 请求耗时<br>数据预拉取，提前拉取，数据缓存在冷启动和页面切换时都起到了很不错的效果：</p>
<p>首页请求速度从平均 400ms 下降到 50ms，优化了 87.5%；</p>
<p>课详页的请求速度从平均 800ms 下降到 90ms，优化了 88.75%；</p>
<p>而数据缓存让二次访问时页面可以秒开：</p>
<p>图片<br>二次加载</p>
<p>使用排队请求之后，对网络请求顺序的干预效果还比较明显，灰度用户业务请求耗时平均有 50-100ms，约 15%的优化；</p>
<p>同时我们通过分析耗时分别在 80 分位、50 分位、20 分位的效果发现，请求耗时越长，优化效果越明显，也就是说在弱网情况下能够更好的发挥作用。</p>
<p>图片<br>请求排队结果</p>
<p>4.3. 渲染<br>使用分步渲染后，我们的页面可以在处理完首屏的基础数据之后就立即开始渲染了，由于我们的目录结构比较复杂，处理起来耗时比较长，所以第二部才处理目录，实际的渲染效果如下图:</p>
<p>图片<br>分步渲染</p>
<p>首屏可以比原来提前 100ms-150ms 渲染出来。</p>
<ol start="5">
<li>总结<br>我们本次的性能优化对小程序启动、请求、交互、渲染多个方面都进行了性能的挖掘，是在对基础库版本要求不高的情况下能做到的极致了。</li>
</ol>
<p>以我们的核心页面首页和课程详情页来说：</p>
<p>首页冷启动耗时开发者可干预的部分优化大概是 1300 下载 + 300 注入 + 170 首渲 + 430 请求 = 2200ms -&gt; 750 + 245 + 170 + 50 = 1215ms，优化了 45%</p>
<p>课详页冷启动耗时开发者可干预的部分优化大概是 1300 下载 + 300 注入 + 170 首渲 + 790 请求 = 2560ms -&gt; 750 + 245 + 170 + 100 = 1265ms，优化了 50.5%</p>
<p>页面切换首次进入详情页耗时从 400 路由 + 800 请求 + 450 处理 = 1650ms -&gt; 400 + 720 + 300 = 1420ms，优化了 14%</p>
<p>二次进入详情页面几乎看不到加载和渲染过程</p>
<p>还有更多的优化手段吗？官方还提供了一些比较高级的功能，对基础库版本要求比较高的，例如：</p>
<p>组件的按需注入和用时注入可以进一步减小代码包下载耗时，但是在我们发布时这个功能还有点问题，会导致首页的自定义组件加载不出来，所以暂时没有使用到。</p>
<p>还可以使用 2.11.1 开始支持的初始渲染缓存，不必等到逻辑层初始化完毕，可以更早的开始渲染视图。</p>
<p>尚在试验阶段的分包异步化，利用异步加载模块的方式也可以减少代码包的下载耗时和 JS 的注入耗时。</p>
<p>利用这些能力可以在更多细节上进行优化，我们也将进一步探索和跟进，如果你有更好的方案欢迎讨论。</p>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/07/06/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E4%BB%8E%E6%B5%8F%E8%A7%88%E5%99%A8%E8%BE%93%E5%85%A5URL%E5%88%B0%E6%98%BE%E7%A4%BA%E9%A1%B5%E9%9D%A2%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88/" rel="prev" title="从浏览器输入URL到显示页面发生了什么">
      <i class="fa fa-chevron-left"></i> 从浏览器输入URL到显示页面发生了什么
    </a></div>
      <div class="post-nav-item"></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="barretyi"
      src="https://avatars.githubusercontent.com/u/7858692?v=4">
  <p class="site-author-name" itemprop="name">barretyi</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">9</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">barretyi</span>
</div>

<!--
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>
-->

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  
  <script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>




  
<script src="/js/local-search.js"></script>













  

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : 'b5ec53da6aa0c8ca1182',
      clientSecret: 'a8ec2da84dfc54dd931c1c04c56d4c10c873879e',
      repo        : 'peipeihai.github.io',
      owner       : 'peipeihai',
      admin       : ['peipeihai'],
      id          : 'c3fead70b8d74ebcced20a7438048a26',
        language: 'zh-CN',
      distractionFreeMode: false
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>

</body>
</html>
